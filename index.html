<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>IPTV Streamer Pro</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        /* Previous styles remain unchanged */
    </style>
</head>
<body>
    <!-- HTML structure remains the same -->
    
    <script>
        const CORS_PROXY = 'https://Simply-iptv.vercel.app/api/proxy?url=';
        const player = document.getElementById('player');
        let hls = null;

        async function playStream(url) {
            try {
                showStatus('Initializing stream...');
                
                if (hls) {
                    hls.destroy();
                    hls = null;
                }

                const proxyUrl = `${CORS_PROXY}${encodeURIComponent(url)}`;
                
                if (Hls.isSupported()) {
                    hls = new Hls({
                        debug: false,
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 30,
                        maxBufferLength: 60,
                        maxMaxBufferLength: 120,
                        maxBufferSize: 60 * 1000 * 1000, // 60MB
                        liveSyncDuration: 30,
                        liveMaxLatencyDuration: 120,
                        xhrSetup: (xhr, mediaUrl) => {
                            const absoluteUrl = new URL(mediaUrl, url).href;
                            xhr.open('GET', `${CORS_PROXY}${encodeURIComponent(absoluteUrl)}`, true);
                        },
                        fragLoading: {
                            default: 'lowLatency',
                            timeout: 10000,
                            maxRetry: 3,
                            retryDelay: 1000
                        }
                    });

                    hls.on(Hls.Events.FRAG_PARSING_DATA, (event, data) => {
                        console.log('Fragment data:', data);
                    });

                    hls.on(Hls.Events.FRAG_PARSING_ERROR, (event, data) => {
                        console.error('Fragment parsing error:', data);
                        handleParsingError(data);
                    });

                    hls.on(Hls.Events.ERROR, (event, data) => {
                        console.error('HLS Error:', data);
                        handlePlaybackError(data);
                    });

                    hls.on(Hls.Events.FRAG_LOADED, (event, data) => {
                        console.log('Fragment loaded:', data.frag.url);
                    });

                    hls.loadSource(proxyUrl);
                    hls.attachMedia(player);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        player.play().catch(() => {
                            showStatus('Click player to start', true);
                        });
                        showStatus('Playing...');
                    });

                } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
                    player.src = proxyUrl;
                    player.play();
                }
            } catch (error) {
                showStatus(`Playback error: ${error.message}`, true);
            }
        }

        function handleParsingError(data) {
            const errorMap = {
                1: 'MP4 remux error',
                2: 'TS container error',
                3: 'AAC timestamp gap',
                4: 'AAC PES header error',
                5: 'MP3 timestamp gap',
                6: 'Audio track loading error',
                7: 'Timestamp rollover',
                8: 'Initialization segment error'
            };
            
            const errorMessage = errorMap[data.reason] || 'Unknown fragment error';
            showStatus(`Fragment error: ${errorMessage}`, true);
            
            // Skip current fragment and reload
            if (hls) {
                hls.recoverMediaError();
                hls.startLoad();
            }
        }

        function handlePlaybackError(data) {
            let errorMessage = 'Playback error: ';
            switch(data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                    errorMessage += `Network error (${data.details})`;
                    hls.startLoad();
                    break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                    errorMessage += `Media error (${data.details})`;
                    hls.recoverMediaError();
                    break;
                case Hls.ErrorTypes.KEY_SYSTEM_ERROR:
                    errorMessage += 'DRM/Key system error';
                    break;
                default:
                    errorMessage += 'Unknown error';
            }
            showStatus(errorMessage, true);
        }

        // Rest of the code remains the same
    </script>
</body>
</html>